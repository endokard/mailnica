#System update
apt-get upgrade
apt-get update

#Non-root user creaton
useradd NEW_USER
passwd NEW_USER

#SSH service configuration -> mailnica/ssh/sshd_conf
vi /etc/sshd_conf
port 27
PermitRootLogin no
AllowAgentForwarding no
AllowTcpForwarding no

#Add new user to sudoers
vi /etc/sudoers

#restart sshd service
systemctl restart sshd

#create mailnica dir
mkdir /etc/mailnca

########
#POSTFIX
########

#install postfix
apt-get install postfix mailutils
systemctl enable postfix

#postfix configuration
#check /mailnica/postfix/

systemctl start postfix

########
########
########

apt install nginx certbot python3-certbot-nginx

########
#NGINX
########

mkdir /var/www/mailnica.com
wget -O /etc/nginx/sites-avaliable/mailnica.com https://raw.githubusercontent.com/endokard/mailnica/main/nginx/sites-avaliable/mailnica.com
ln -s /etc/nginx/sites-available/mailnica.com /etc/nginx/sites-enabled/mailnica.com

systemctl enable nginx
########
#CERTBOT
########
certbot certonly --webroot -w /var/www/mailnica.com -d mailnica.com


########
#DOVECOT
########
apt install dovecot-core dovecot-imapd dovecot-pop3d
vi /etc/dovecot/dovecot.conf
 protocols = imap pop3

vi /etc/dovecot/conf.d/10-mail.conf
 mail_location = maildir:~/Maildir

vi /etc/dovecot/conf.d/10-auth.conf
 disable_plaintext_auth = yes
 auth_username_format = %n

vi /etc/dovecot/conf.d/10-ssl.conf
 ssl = required
 ssl_cert = </etc/letsencrypt/live/mailnica.com/fullchain.pem
 ssl_key = </etc/letsencrypt/live/mailnica.com/privkey.pem
 ssl_prefer_server_ciphers = yes
 ssl_min_protocol = TLSv1.2
 ssl_protocols = !SSLv3 !TLSv1 !TLSv1.1
 
vi /etc/dovecot/conf.d/10-master.conf
 
vi /etc/dovecot/conf.d/15-mailboxes.conf

adduser dovecot mail

apt install dovecot-lmtpd

vi /etc/dovecot/dovecot.conf
 protocols = imap lmtp

vi /etc/dovecot/conf.d/10-master.conf
 service lmtp {
 unix_listener /var/spool/postfix/private/dovecot-lmtp {
   mode = 0600
   user = postfix
   group = postfix
  }
}

vi /etc/postfix/main.cf
mailbox_transport = lmtp:unix:private/dovecot-lmtp
smtputf8_enable = no

systemctl enable dovecot

systemctl restart postfix dovecot

########
#MariaDB
########

apt install mariadb-server mariadb-client
systemctl enable mariadb
mysql_secure_installation

########
#PostfixAdmin
########
apt install dbconfig-no-thanks
apt install postfixadmin
apt remove dbconfig-no-thanks

dpkg-reconfigure postfixadmin

vi /etc/dbconfig-common/postfixadmin.conf
 dbc_dbtype='mysqli'

vi /etc/postfixadmin/dbconfig.inc.php
 $dbtype='mysqli';
 
mkdir /usr/share/postfixadmin/templates_c
apt install acl
setfacl -R -m u:www-data:rwx /usr/share/postfixadmin/templates_c/

vi /etc/nginx/sites-avaliable/adm.mailnica.com


systemctl disable --now apache2
apt install php php-cli php-fpm php-json php-common php-mysql php-zip php-gd php-mbstring php-curl php-xml php-pear php-bcmath
apt install php7.4-fpm php7.4-imap php7.4-mbstring php7.4-mysql php7.4-json php7.4-curl php7.4-zip php7.4-xml php7.4-bz2 php7.4-intl php7.4-gmp

vi /usr/share/postfixadmin/config.local.php

ln -s /usr/share/postfixadmin/config.local.php /etc/postfixadmin/config.local.php

http://adm.mailnica.com/setup.php

apt install postfix-mysql

vi /etc/postfix/main.cf

mkdir /etc/postfix/sql/

vi /etc/postfix/sql/mysql_virtual_domains_maps.cf

vi /etc/postfix/sql/mysql_virtual_mailbox_maps.cf

vi /etc/postfix/sql/mysql_virtual_alias_domain_mailbox_maps.cf

vi /etc/postfix/sql/mysql_virtual_alias_maps.cf

vi /etc/postfix/sql/mysql_virtual_alias_domain_maps.cf

vi /etc/postfix/sql/mysql_virtual_alias_domain_catchall_maps.cf

chmod 0640 /etc/postfix/sql/*
setfacl -R -m u:postfix:rx /etc/postfix/sql/

postconf -e "mydestination = \$myhostname, localhost.\$mydomain, localhost"

vi /etc/postfix/main.cf

systemctl restart postfix

adduser vmail --system --group --uid 2000 --disabled-login --no-create-home
mkdir /var/vmail/
chown vmail:vmail /var/vmail/ -R

#######
#DovecotNySql
#######
apt install dovecot-mysql
vi /etc/dovecot/conf.d/10-mail.conf
 mail_home = /var/vmail/%d/%n/
 
vi /etc/dovecot/conf.d/10-auth.conf
 auth_username_format = %u
 !include auth-sql.conf.ext
 #!include auth-system.conf.ext
 auth_debug = yes
 auth_debug_passwords = yes
 
vi /etc/dovecot/dovecot-sql.conf.ext
 
systemctl restart dovecot

######
#SSLNginx
#####
vi /etc/nginx/snippets/ssl-params.conf
openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048
vi /etc/nginx/sites-available/mailnica.com

######
#Roundcube
######

 wget https://github.com/roundcube/roundcubemail/releases/download/1.4.11/roundcubemail-1.4.11-complete.tar.gz
 tar xvf roundcubemail-1.4.11-complete.tar.gz
 mv roundcubemail-1.4.6 /var/www/roundcube
 
 apt install php-net-ldap2 php-net-ldap3 php-imagick php-common php-gd php-imap php-json php-curl php-zip php-xml php-mbstring php-bz2 php-intl php-gmp
 apt install composer
 cd /var/www/roundcube
 composer install --no-dev
 chown www-data:www-data temp/ logs/ -R
 
 mysql -u root
 CREATE DATABASE roundcube DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;
 CREATE USER roundu@localhost IDENTIFIED BY 'password';
 GRANT ALL PRIVILEGES ON roundcube.* TO roundu@localhost;
 flush privileges;
 exit;
 mysql roundcube < /var/www/roundcube/SQL/mysql.initial.sql
 
 vi /etc/nginx/sites-available/roundcube.conf
 
 
 
